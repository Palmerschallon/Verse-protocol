<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Verse — Seed → Dream (Shader Param v2)</title>
<style>
  :root{
    --bg:#0b0c10; --ink:#e9eef5; --muted:#a5b0bf; --outline:rgba(255,255,255,.08);
    --panel:rgba(255,255,255,.03); --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --serif: "Iowan Old Style","Georgia",serif; --hint:#8fd3ff;
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink)}
  .page{display:grid;grid-template-columns:22% 1fr 22%;gap:1rem;height:100dvh;padding:1rem;overflow:hidden}
  @media(max-width:1000px){.page{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;height:auto;min-height:100dvh}}
  .panel{border:1px solid var(--outline);background:var(--panel);border-radius:12px;padding:1rem;overflow:auto}
  .left{font-family:var(--mono);opacity:.6} .right{font-style:italic;opacity:.6}
  .center{display:flex;flex-direction:column;gap:.75rem;min-width:0}
  /* Square visual window */
  #vizWrap{position:relative;aspect-ratio:1/1;width:100%;border:1px solid var(--outline);border-radius:12px;overflow:hidden}
  #viz{width:100%;height:100%;display:block}
  .wm{position:absolute; right:10px; bottom:8px; font:700 10px/1 var(--mono); color:rgba(255,255,255,.35); pointer-events:none; letter-spacing:.06em}
  .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
  .seedbar{border:1px solid var(--outline);border-radius:12px;padding:.55rem .7rem;background:var(--panel)}
  .seedbar input{flex:1;background:transparent;border:none;color:var(--ink);font:inherit;outline:none}
  .seedbar input::placeholder{color:var(--muted)}
  .seedbar button{background:var(--outline);border:1px solid var(--outline);color:var(--ink);padding:.4rem .65rem;border-radius:6px;font:600 11px var(--mono);cursor:pointer;transition:background .2s}
  .seedbar button:hover{background:rgba(255,255,255,.1)}
  .controls{display:flex;flex-direction:column;gap:.5rem}
  .ctrl{display:flex;align-items:center;gap:.5rem;font:600 11px var(--mono)}
  .ctrl label{width:70px;color:var(--muted);text-align:right}
  .ctrl input[type=range]{flex:1;height:20px;background:var(--outline);border-radius:10px;outline:none;-webkit-appearance:none}
  .ctrl input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--hint);border-radius:50%;cursor:pointer}
  .ctrl input[type=range]::-moz-range-thumb{width:16px;height:16px;background:var(--hint);border-radius:50%;cursor:pointer;border:none}
  .toggle{display:flex;align-items:center;gap:.5rem;font:600 11px var(--mono)}
  .toggle input[type=checkbox]{margin:0}
  .toggle button{background:var(--outline);border:1px solid var(--outline);color:var(--ink);padding:.4rem .65rem;border-radius:6px;font:inherit;cursor:pointer;transition:background .2s}
  .toggle button:hover{background:rgba(255,255,255,.1)}
  .scroll{max-height:40vh;overflow-y:auto;font-family:var(--serif);line-height:1.6}
  .scroll h1{font:700 16px var(--mono);color:var(--hint);text-align:center;margin:0 0 1rem}
  .scroll p{margin:.75rem 0;text-indent:1em}
  .scroll blockquote{margin:1rem 0;padding-left:1rem;border-left:2px solid var(--outline);font-style:italic;color:var(--muted)}
  pre{font:11px var(--mono);background:var(--outline);padding:.75rem;border-radius:6px;overflow-x:auto;line-height:1.4;color:var(--muted)}
  h3{font:700 13px var(--mono);color:var(--hint);margin:0 0 .5rem}
</style>
</head>
<body>
<div class="page">
  <aside class="panel left">
    <pre>// SeedID = SHA256( canonical(seed) + "WebGL-Dream-003" )
params:
  p0 palette
  p1 complexity (quantity baseline)
  p2 freq
  p3 grain
  p4 maskBias (if mask on)
  p5 drift

user controls:
  time (scrub), speed, quantity, scale, mask on/off

enhancements (v2):
  • filament streaks along flow
  • slight contrast bump (tonemap)
  • deterministic Random (curated cycle)</pre>
  </aside>

  <main class="panel center">
    <div id="vizWrap">
      <canvas id="viz"></canvas>
      <div class="wm">Built on Verse</div>
    </div>

    <div class="row seedbar">
      <input id="seed" placeholder='Type a seed… e.g. "sphere of silence"' />
      <button id="prev">◀︎ Prev</button>
      <button id="rand">Next</button>
      <button id="reset">Reset</button>
      <button id="share">Share</button>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;font:11px var(--mono);color:var(--muted)">
      <span id="seedID">SeedID: 0</span>
      <span style="font:700 11px var(--mono);color:var(--muted)">Engine: WebGL-Dream-003</span>
    </div>

    <div class="controls">
      <div class="ctrl"><label>Time</label><input id="time" class="hint-range hinting" type="range" min="0" max="600" step="1" value="0"></div>
      <div class="ctrl"><label>Speed</label><input id="speed" type="range" min="0" max="300" step="1" value="120"></div>
      <div class="ctrl"><label>Quantity</label><input id="qty" type="range" min="0" max="100" step="1" value="60"></div>
      <div class="ctrl"><label>Scale</label><input id="scale" type="range" min="10" max="300" step="1" value="110"></div>
      <div class="toggle"><input id="mask" type="checkbox"><label style="font:700 11px var(--mono);color:var(--muted)">Radial Mask</label></div>
      <div class="toggle"><button id="play">⏸ Pause</button></div>
      <div class="toggle"><button id="copy">Copy URL</button></div>
    </div>

    <section class="scroll">
      <h1>✶ The White Scroll of Verse ✶</h1>
      <p>From silence, a seed. The world saw numbers; the wise saw a covenant. And the covenant learned to dream.</p>
      <blockquote>"Chancellor on brink of second bailout for banks."</blockquote>
      <p>Verse inherits the seed and extends it: words become light, time becomes motion, quantity becomes weather, scale becomes perspective. Plant a seed; watch it become.</p>
    </section>
  </main>

  <aside class="panel right">
    <h3>Commentary</h3>
    <p>Each seed births a deterministic universe. The algorithm remains constant; the exploration infinite.</p>
    <p>This is not randomness but revelation—each parameter precisely derived from the seed's DNA.</p>
    <p>The visual emerges from wave interference patterns, each frequency locked to its source.</p>
    <h3>Specifications</h3>
    <p>Engine versioning ensures forward compatibility. WebGL-Dream-003 marks this constellation.</p>
    <p>Determinism anchors trust. Evolution lives in versions. Culture emerges in constellations.</p>
    <p>Shader-param first to ship the feeling; agents later if the world asks.</p>
  </aside>
</div>

<script type="module">
/* ---------- Deterministic params from seed ---------- */
function djb2x(str){let h=5381;for(let i=0;i<str.length;i++)h=((h<<5)+h)^str.charCodeAt(i);return h>>>0;}
function lcg(seed){let s=(seed>>>0)||1;return()=>((s=(1664525*s+1013904223)>>>0)/4294967296);}
function paramsFromSeed(seed){
  const base=djb2x(seed.trim()||"sphere of silence");
  const r=lcg(base);
  return {
    id:base>>>0,
    p0:r(), p1:r(), p2:r(), p3:r(), p4:r(), p5:r(),
    speed: 0.7 + 1.3*r(),
    qty:   Math.floor(35 + 65*r()),
    scale: 0.9 + 1.3*r(),
    t0:    Math.floor(600*r())
  };
}

/* ---------- GL setup ---------- */
const DPR=Math.min(2, devicePixelRatio||1);
const cvs=document.getElementById('viz');
const gl=cvs.getContext('webgl',{antialias:false,depth:false});
function fitSquare(){
  const rect=cvs.parentElement.getBoundingClientRect();
  const side=Math.min(rect.width, rect.height);
  cvs.style.width=side+"px"; cvs.style.height=side+"px";
  cvs.width=Math.max(2,Math.floor(side*DPR));
  cvs.height=Math.max(2,Math.floor(side*DPR));
  gl.viewport(0,0,cvs.width,cvs.height);
}
addEventListener('resize',fitSquare,{passive:true}); fitSquare();

/* ---------- UI ---------- */
const seedEl = document.getElementById('seed');
const timeEl = document.getElementById('time');
const speedEl= document.getElementById('speed');
const qtyEl  = document.getElementById('qty');
const scaleEl= document.getElementById('scale');
const maskEl = document.getElementById('mask');
const playEl = document.getElementById('play');
const randEl = document.getElementById('rand');
const prevEl = document.getElementById('prev');
const resetEl= document.getElementById('reset');
const copyEl = document.getElementById('copy');
const shareEl= document.getElementById('share');

const CYCLE=[
  'sphere of silence','breath in the void','whispering swarm','ink of stars',
  'glass orb tide','constellation memory','garden of hashes','first spark again'
];
let cycleIndex=0;

function setFromParams(p){
  seedEl.dataset.sid = String(p.id);
  timeEl.value = p.t0;
  speedEl.value= Math.round(p.speed*100);
  qtyEl.value  = p.qty;
  scaleEl.value= Math.round(p.scale*100);
  maskEl.checked = false;
}

/* ---------- Shaders (v2 with filament streaks + tonemap) ---------- */
const vert=`attribute vec2 aPos;void main(){gl_Position=vec4(aPos,0.,1.);} `;
const frag=`
precision highp float;
uniform vec2 res;
uniform float t;     // time seconds
uniform float spd;   // speed multiplier
uniform float qty;   // 0..1 complexity
uniform float scl;   // zoom
uniform float useMask; // 0/1
uniform vec4 P01; uniform vec4 P23; uniform vec4 P45;

vec3 hue(float h){
  h=fract(h);
  float r=abs(h*6.-3.)-1.;
  float g=2.-abs(h*6.-2.);
  float b=2.-abs(h*6.-4.);
  return clamp(vec3(r,g,b),0.,1.);
}
float noise(vec2 p){ return fract(sin(dot(p,vec2(12.9898,78.233)))*43758.5453); }

void main(){
  vec2 uv=(gl_FragCoord.xy-0.5*res)/res.y;
  uv*=scl;

  float p0=P01.x; float p1=P01.y; float p2=P23.x; float p3=P23.y; float p4=P45.x; float p5=P45.y;

  // wave interference patterns - use fixed loop with dynamic complexity
  vec3 col=vec3(0);
  float tt=t*0.3*(0.5+p5);
  float complexity = qty*p1;
  
  for(int i=0; i<100; i++){
    if(float(i) >= complexity*100.0) break;
    
    float fi = float(i);
    vec2 offset = vec2(cos(fi*0.718+p2*6.28), sin(fi*0.718+p2*6.28)) * (0.5+1.5*noise(vec2(fi*0.1,p3)));
    float phase = fi*0.1 + tt + p5*fi*0.05;
    float d = length(uv - offset*mix(0.3,1.5,p1));
    float wave = sin(d*mix(8.,40.,p2) - phase*2.) * exp(-d*mix(1.,6.,p3));
    
    // filament streaks along flow
    vec2 flow = normalize(uv - offset*mix(0.3,1.5,p1));
    float streak = smoothstep(0.02, 0.0, abs(dot(uv - offset*mix(0.3,1.5,p1), vec2(-flow.y, flow.x))));
    wave += streak * 0.3 * exp(-d*2.);
    
    float hueShift = p0 + fi*0.1 + wave*0.1;
    col += hue(hueShift) * wave * wave * (0.5+0.5*sin(fi*0.5+tt));
  }

  col *= 0.8/(complexity*100.0 + 1.0);
  
  // radial mask (optional)
  if(useMask > 0.5){
    float r = length(uv);
    float m = smoothstep(1.35, mix(0.25,1.0,p4), r);
    col *= (1.0 - m);
  }

  // contrast/tonemap bump
  col = pow(col, vec3(0.9));
  gl_FragColor = vec4(col,1.0);
}
`;

function compile(type,src){
  const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s);
  if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) console.warn(gl.getShaderInfoLog(s));
  return s;
}
const prog=gl.createProgram();
gl.attachShader(prog,compile(gl.VERTEX_SHADER,vert));
gl.attachShader(prog,compile(gl.FRAGMENT_SHADER,frag));
gl.linkProgram(prog); gl.useProgram(prog);

const buf=gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1, 1,-1, -1,1, 1,1]),gl.STATIC_DRAW);
const aPos=gl.getAttribLocation(prog,'aPos');
gl.enableVertexAttribArray(aPos);
gl.vertexAttribPointer(aPos,2,gl.FLOAT,false,0,0);

const uRes=gl.getUniformLocation(prog,'res');
const uT  =gl.getUniformLocation(prog,'t');
const uSpd=gl.getUniformLocation(prog,'spd');
const uQty=gl.getUniformLocation(prog,'qty');
const uScl=gl.getUniformLocation(prog,'scl');
const uMask=gl.getUniformLocation(prog,'useMask');
const uP01=gl.getUniformLocation(prog,'P01');
const uP23=gl.getUniformLocation(prog,'P23');
const uP45=gl.getUniformLocation(prog,'P45');

/* ---------- State ---------- */
let seed='sphere of silence';
let P=paramsFromSeed(seed);
seedEl.value=seed; setFromParams(P);

/* URL sync */
function pushURL(){
  const q=new URLSearchParams({
    s: seedEl.value, t: timeEl.value, v: speedEl.value, q: qtyEl.value, z: scaleEl.value, m: maskEl.checked?'1':'0'
  });
  history.replaceState(null,'','?'+q.toString());
}

function pullURL(){
  const q=new URLSearchParams(location.search);
  if(q.get('s')) seedEl.value=q.get('s');
  if(q.get('t')) timeEl.value=q.get('t');
  if(q.get('v')) speedEl.value=q.get('v');
  if(q.get('q')) qtyEl.value=q.get('q');
  if(q.get('z')) scaleEl.value=q.get('z');
  if(q.get('m')) maskEl.checked=q.get('m')==='1';
}
pullURL();

/* Seed application */
function applySeed(){
  seed=seedEl.value||'sphere of silence';
  P=paramsFromSeed(seed);
  if(!location.search){ setFromParams(P); }
  document.getElementById('seedID').textContent = 'SeedID: ' + P.id;
  pushURL();
}
seedEl.addEventListener('input',applySeed);
applySeed(); // Initialize on load

/* Curated cycle (deterministic exploration) */
function setCycle(i){ cycleIndex=(i+ CYCLE.length)%CYCLE.length; seedEl.value=CYCLE[cycleIndex]; applySeed(); }
randEl.addEventListener('click',()=> setCycle(cycleIndex+1));
prevEl.addEventListener('click',()=> setCycle(cycleIndex-1));

resetEl.addEventListener('click',()=>{ seedEl.value='sphere of silence'; applySeed(); });
shareEl.addEventListener('click',()=>{ pushURL(); });

copyEl.addEventListener('click',()=>{
  pushURL();
  navigator.clipboard?.writeText(location.href);
});

/* Animation */
let playing=false, last=performance.now(), tSeconds=parseFloat(timeEl.value)||0;
playEl.addEventListener('click',()=>{playing=!playing; playEl.textContent=playing?'⏸ Pause':'▶︎ Play'; last=performance.now(); });

function tick(now){
  const dt=(now-last)/1000; last=now;
  const speedMul = (parseInt(speedEl.value)||120)/100;
  if(playing){ tSeconds += dt * speedMul; timeEl.value = Math.max(0,Math.min(600, tSeconds)); }
  else { tSeconds = parseFloat(timeEl.value)||0; }

  gl.uniform2f(uRes, cvs.width, cvs.height);
  gl.uniform1f(uT, tSeconds);
  gl.uniform1f(uSpd, speedMul);
  gl.uniform1f(uQty, (parseInt(qtyEl.value)||60)/100);
  gl.uniform1f(uScl, (parseInt(scaleEl.value)||110)/100);
  gl.uniform1f(uMask, maskEl.checked?1.0:0.0);

  gl.uniform4f(uP01, P.p0, P.p1, 0,0);
  gl.uniform4f(uP23, P.p2, P.p3, 0,0);
  gl.uniform4f(uP45, P.p4, P.p5, 0,0);

  gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* initial fit */
function fit(){fitSquare(); pushURL();}
addEventListener('load',fit,{once:true});
</script>
</body>
</html>